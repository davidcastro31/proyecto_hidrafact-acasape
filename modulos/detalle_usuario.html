<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Detalle de Usuario</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f8f9fa; min-height: 100vh; }
        .navbar { background-color: #0d6efd !important; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card { border: none; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 20px; }
        .user-header { background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%); color: white; border-radius: 15px; padding: 30px; margin-bottom: 25px; }
        .user-header.blocked { background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); }
        .user-header.warning { background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: #000; }
        .stat-card { background: white; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: transform 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .stat-value { font-size: 2rem; font-weight: bold; margin: 10px 0; }
        .table thead th { background-color: #0d6efd; color: white; border: none; font-weight: 600; text-transform: uppercase; font-size: 0.85rem; }
        .nav-pills .nav-link { border-radius: 10px; font-weight: 500; }
        .nav-pills .nav-link.active { background-color: #0d6efd; }
        #txtBuscarUsuario { border-radius: 20px; padding-left: 2.5rem; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23999' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: 10px center; }
        .timeline-item { border-left: 3px solid #0d6efd; padding-left: 20px; margin-bottom: 20px; position: relative; }
        .timeline-item::before { content: ''; position: absolute; left: -8px; top: 0; width: 13px; height: 13px; border-radius: 50%; background-color: #0d6efd; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <div class="d-flex align-items-center w-100">
                <button class="btn btn-outline-light rounded-circle me-3" onclick="window.location.href='/index.html'">
                    <i class="bi bi-arrow-left"></i>
                </button>
                <h4 class="text-white mb-0 flex-grow-1 text-center fw-bold">
                    <i class="bi bi-person-lines-fill me-2"></i>DETALLE DE USUARIO
                </h4>
                <div class="d-flex gap-2 align-items-center">
                    <button class="btn btn-outline-light btn-sm" id="btnAnterior" title="Usuario anterior">
                        <i class="bi bi-arrow-left-circle"></i>
                    </button>
                    <button class="btn btn-outline-light btn-sm" id="btnSiguiente" title="Usuario siguiente">
                        <i class="bi bi-arrow-right-circle"></i>
                    </button>
                    <input type="text" id="txtBuscarUsuario" class="form-control form-control-sm" placeholder="Buscar usuario..." style="width: 250px;">
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4 px-4" id="vistaSeleccion">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Seleccione un Usuario</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th style="width: 80px;">#</th>
                                <th>Nombre Completo</th>
                                <th style="width: 150px;">N¬∞ Contador</th>
                                <th style="width: 120px;" class="text-center">Estado</th>
                                <th style="width: 150px;" class="text-center">Morosidad</th>
                            </tr>
                        </thead>
                        <tbody id="tblSeleccionUsuarios">
                            <tr>
                                <td colspan="5" class="text-center py-4 text-muted">Cargando usuarios...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-4 px-4" id="vistaDetalle" style="display: none;">
        <div class="user-header" id="userHeader">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-white text-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 80px; height: 80px; font-size: 2.5rem;">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <div class="ms-4">
                            <h2 class="mb-1 fw-bold" id="txtNombreUsuario">-</h2>
                            <p class="mb-0 opacity-75"><i class="bi bi-hash"></i> ID: <span id="txtIdUsuario">-</span> | <i class="bi bi-speedometer"></i> Contador: <span id="txtContador">-</span></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-2"><i class="bi bi-envelope-fill me-2"></i><strong>Correo:</strong> <span id="txtCorreo">-</span></p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2"><i class="bi bi-toggle-on me-2"></i><strong>Estado:</strong> <span id="txtEstado">-</span></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div id="alertaEstado"></div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon text-primary"><i class="bi bi-receipt"></i></div>
                    <div class="stat-value text-primary" id="totalFacturas">0</div>
                    <div class="text-muted fw-semibold">Total Facturas</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon text-warning"><i class="bi bi-clock-history"></i></div>
                    <div class="stat-value text-warning" id="facturasPendientes">0</div>
                    <div class="text-muted fw-semibold">Pendientes</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon text-danger"><i class="bi bi-exclamation-triangle-fill"></i></div>
                    <div class="stat-value text-danger" id="facturasVencidas">0</div>
                    <div class="text-muted fw-semibold">Vencidas</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-icon text-success"><i class="bi bi-check-circle-fill"></i></div>
                    <div class="stat-value text-success" id="facturasPagadas">0</div>
                    <div class="text-muted fw-semibold">Pagadas</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <ul class="nav nav-pills mb-4" id="tabsDetalle" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="facturas-tab" data-bs-toggle="pill" data-bs-target="#facturas" type="button">
                            <i class="bi bi-receipt me-2"></i>Facturas
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="lecturas-tab" data-bs-toggle="pill" data-bs-target="#lecturas" type="button">
                            <i class="bi bi-clipboard-data me-2"></i>Lecturas
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pagos-tab" data-bs-toggle="pill" data-bs-target="#pagos" type="button">
                            <i class="bi bi-credit-card me-2"></i>Pagos
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="tabsDetalleContent">
                    <div class="tab-pane fade show active" id="facturas" role="tabpanel">
                        <div class="mb-3 d-flex align-items-center gap-2">
                            <select class="form-select w-auto" id="filtroEstadoFacturas">
                                <option value="">Todas las facturas</option>
                                <option value="Pendiente">Pendientes</option>
                                <option value="Vencida">Vencidas</option>
                                <option value="Pagada">Pagadas</option>
                                <option value="Anulada">Anuladas</option>
                            </select>
                            <button class="btn btn-outline-primary" id="btnExportarFacturas"><i class="bi bi-file-earmark-spreadsheet"></i> Exportar</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>N¬∞ Factura</th>
                                        <th>Tipo</th>
                                        <th>Fecha Emisi√≥n</th>
                                        <th>Vencimiento</th>
                                        <th>Monto</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="tblFacturas">
                                    <tr><td colspan="6" class="text-center py-4 text-muted">No hay facturas registradas</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="lecturas" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Lectura Anterior (m¬≥)</th>
                                        <th>Lectura Actual (m¬≥)</th>
                                        <th>Consumo (m¬≥)</th>
                                        <th>Estado Factura</th>
                                    </tr>
                                </thead>
                                <tbody id="tblLecturas">
                                    <tr><td colspan="5" class="text-center py-4 text-muted">No hay lecturas registradas</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="pagos" role="tabpanel">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Fecha Pago</th>
                                        <th>N¬∞ Factura</th>
                                        <th>Tipo Factura</th>
                                        <th>Monto Pagado</th>
                                        <th>M√©todo</th>
                                    </tr>
                                </thead>
                                <tbody id="tblPagos">
                                    <tr><td colspan="5" class="text-center py-4 text-muted">No hay pagos registrados</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let usuarios = [];
        let usuarioActual = null;
        let usuarioActualIndex = 0;
        let detalleCache = null; // almacena la respuesta de /api/detalle_usuario

        document.addEventListener('DOMContentLoaded', async () => {
            await cargarUsuarios();
        });

        async function cargarUsuarios() {
            try {
                let res = await fetch('/api/usuarios');
                usuarios = await res.json();
                mostrarListaUsuarios(usuarios);
            } catch (e) {
                console.error('Error cargando usuarios', e);
            }
        }

        // b√∫squeda en la lista
        txtBuscarUsuario.addEventListener('input', async () => {
            let termino = txtBuscarUsuario.value;
            try {
                let res = await fetch(`/api/buscar_usuarios?q=${encodeURIComponent(termino)}`);
                usuarios = await res.json();
                if (vistaDetalle.style.display === 'none') {
                    mostrarListaUsuarios(usuarios);
                } else if (usuarios.length > 0) {
                    usuarioActualIndex = 0;
                    await mostrarDetalleUsuario(usuarios[0]);
                }
            } catch (e) {
                console.error('Error en b√∫squeda', e);
            }
        });

        btnAnterior.addEventListener('click', async () => {
            if (usuarioActualIndex > 0) { usuarioActualIndex--; await mostrarDetalleUsuario(usuarios[usuarioActualIndex]); }
        });
        btnSiguiente.addEventListener('click', async () => {
            if (usuarioActualIndex < usuarios.length - 1) { usuarioActualIndex++; await mostrarDetalleUsuario(usuarios[usuarioActualIndex]); }
        });

        function mostrarListaUsuarios(lista) {
            let filas = "";
            if (!lista || lista.length === 0) {
                filas = `<tr><td colspan="5" class="text-center py-4"><i class="bi bi-inbox" style="font-size:2rem;color:#ccc"></i><p class="text-muted mt-2">No se encontraron usuarios</p></td></tr>`;
            } else {
                lista.forEach((u, idx) => {
                    let badgeEstado = u.estado === 'Activo' ? '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Activo</span>' : '<span class="badge bg-secondary"><i class="bi bi-dash-circle me-1"></i>Inactivo</span>';
                    let facturas_vencidas = u.facturas_vencidas || 0;
                    let badgeMorosidad = '';
                    if (facturas_vencidas >= 3) badgeMorosidad = `<span class="badge bg-danger">üö´ BLOQUEADO (${facturas_vencidas})</span>`;
                    else if (facturas_vencidas > 0) badgeMorosidad = `<span class="badge bg-warning text-dark">‚ö† ${facturas_vencidas}</span>`;
                    else badgeMorosidad = '<span class="badge bg-success">‚úì Al d√≠a</span>';

                    filas += `
                        <tr onclick='seleccionarUsuario(${idx})' style="cursor:pointer;">
                            <td class="fw-semibold text-muted">${u.idUsuario}</td>
                            <td class="fw-semibold">${u.nombre}</td>
                            <td><span class="badge bg-light text-dark">${u.num_contador}</span></td>
                            <td class="text-center">${badgeEstado}</td>
                            <td class="text-center">${badgeMorosidad}</td>
                        </tr>
                    `;
                });
            }
            tblSeleccionUsuarios.innerHTML = filas;
        }

        function seleccionarUsuario(index) {
            usuarioActualIndex = index;
            mostrarDetalleUsuario(usuarios[index]);
        }

        async function mostrarDetalleUsuario(usuario) {
            usuarioActual = usuario;
            vistaSeleccion.style.display = 'none';
            vistaDetalle.style.display = 'block';

            // CAMPOS b√°sicos
            txtIdUsuario.textContent = usuario.idUsuario;
            txtNombreUsuario.textContent = usuario.nombre;
            txtContador.textContent = usuario.num_contador || '-';
            txtCorreo.textContent = usuario.correo || 'Sin correo';
            txtEstado.innerHTML = usuario.estado === 'Activo' ? '<span class="badge bg-success fs-6"><i class="bi bi-check-circle me-1"></i>Activo</span>' : '<span class="badge bg-secondary fs-6"><i class="bi bi-dash-circle me-1"></i>Inactivo</span>';

            // llamar al endpoint agrupado
            await cargarDetalle(usuario.idUsuario);
        }

        async function cargarDetalle(idUsuario) {
            try {
                let res = await fetch(`/api/detalle_usuario?idUsuario=${idUsuario}`);
                if (!res.ok) throw new Error('No se pudo obtener detalle');
                let data = await res.json();
                detalleCache = data;

                // Estad√≠sticas
                document.getElementById('totalFacturas').textContent = data.facturas.total || 0;
                document.getElementById('facturasPendientes').textContent = data.facturas.pendientes || 0;
                document.getElementById('facturasVencidas').textContent = data.facturas.vencidas || 0;
                document.getElementById('facturasPagadas').textContent = data.facturas.pagadas || 0;

                // Cabecera alerta
                actualizarCabeceraMorosidad(data.morosidad);

                // Llenar tablas
                mostrarFacturas(data.facturas.detalle || []);
                mostrarLecturas(data.lecturas || []);
                mostrarPagos(data.pagos || []);
            } catch (e) {
                console.error('Error cargando detalle:', e);
                Swal.fire({ icon: 'error', title: 'Error', text: 'No se pudo cargar el detalle del usuario' });
            }
        }

        function actualizarCabeceraMorosidad(morosidad) {
            let userHeader = document.getElementById('userHeader');
            let alertaEstado = document.getElementById('alertaEstado');
            userHeader.className = 'user-header';
            alertaEstado.innerHTML = '';

            if (morosidad.bloqueado) {
                userHeader.classList.add('blocked');
                alertaEstado.innerHTML = `<div class="alert alert-danger mb-0" style="background-color: rgba(255,255,255,0.2); border: 2px solid white;"><h5 class="mb-2"><i class="bi bi-exclamation-triangle-fill me-2"></i>USUARIO BLOQUEADO</h5><p class="mb-0">${morosidad.facturas_vencidas} facturas vencidas</p><small>No se pueden generar nuevas facturas</small></div>`;
            } else if (morosidad.facturas_vencidas > 0) {
                userHeader.classList.add('warning');
                alertaEstado.innerHTML = `<div class="alert alert-warning mb-0" style="background-color: rgba(255,255,255,0.3); border: 2px solid white; color: #000;"><h5 class="mb-2"><i class="bi bi-exclamation-circle-fill me-2"></i>ADVERTENCIA</h5><p class="mb-0">${morosidad.facturas_vencidas} factura(s) vencida(s)</p><small>Las nuevas facturas incluir√°n mora</small></div>`;
            } else {
                alertaEstado.innerHTML = `<div class="alert alert-success mb-0" style="background-color: rgba(255,255,255,0.2); border: 2px solid white;"><h5 class="mb-2"><i class="bi bi-check-circle-fill me-2"></i>AL D√çA</h5><p class="mb-0">Sin facturas vencidas</p><small>Usuario al corriente en pagos</small></div>`;
            }
        }

        // Mostrar facturas
        let facturasOriginales = [];
        function mostrarFacturas(facturas) {
            facturasOriginales = facturas;
            let filas = "";
            if (!facturas || facturas.length === 0) {
                filas = `<tr><td colspan="6" class="text-center py-4"><i class="bi bi-inbox" style="font-size:2rem;color:#ccc"></i><p class="text-muted mt-2">No hay facturas con este filtro</p></td></tr>`;
            } else {
                facturas.forEach(f => {
                    let fe = new Date(f.fechaEmision + 'T00:00:00').toLocaleDateString('es-SV');
                    let fv = new Date(f.fechaVencimiento + 'T00:00:00').toLocaleDateString('es-SV');
                    let badge = '';
                    if (f.estado === 'Pendiente') badge = '<span class="badge bg-warning text-dark"><i class="bi bi-clock me-1"></i>Pendiente</span>';
                    else if (f.estado === 'Pagada') badge = '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Pagada</span>';
                    else if (f.estado === 'Vencida') badge = '<span class="badge bg-danger"><i class="bi bi-exclamation-triangle me-1"></i>Vencida</span>';
                    else if (f.estado === 'Anulada') badge = '<span class="badge bg-secondary">Anulada</span>';

                    filas += `
                        <tr>
                            <td class="fw-semibold">${f.idFactura}</td>
                            <td>${f.tipoFactura || '-'}</td>
                            <td>${fe}</td>
                            <td>${fv}</td>
                            <td><span class="badge bg-primary fs-6">$${parseFloat(f.montoTotal || 0).toFixed(2)}</span></td>
                            <td>${badge}</td>
                        </tr>
                    `;
                });
            }
            tblFacturas.innerHTML = filas;
        }

        // filtro de facturas
        filtroEstadoFacturas.addEventListener('change', () => {
            let estado = filtroEstadoFacturas.value;
            if (!estado) mostrarFacturas(facturasOriginales);
            else showFiltered = facturasOriginales.filter(f => f.estado === estado) , mostrarFacturas(facturasOriginales.filter(f => f.estado === estado));
        });

        // Mostrar lecturas
        async function mostrarLecturas(lecturas) {
            let filas = "";
            if (!lecturas || lecturas.length === 0) {
                filas = `<tr><td colspan="5" class="text-center py-4"><i class="bi bi-inbox" style="font-size:2rem;color:#ccc"></i><p class="text-muted mt-2">No hay lecturas registradas</p></td></tr>`;
            } else {
                for (let lectura of lecturas) {
                    let fecha = new Date(lectura.fechaLectura + 'T00:00:00').toLocaleDateString('es-SV');
                    let prev = parseFloat(lectura.lecturaAnterior || 0).toFixed(2);
                    let curr = parseFloat(lectura.lecturaActual || 0).toFixed(2);
                    let consumo = (parseFloat(lectura.lecturaActual || 0) - parseFloat(lectura.lecturaAnterior || 0)).toFixed(2);

                    // solicitar verificaci√≥n de factura para esta lectura (falla silenciosa si endpoint no resuelve r√°pido)
                    let estadoFacturaBadge = '<span class="badge bg-secondary">Sin factura</span>';
                    try {
                        // usamos el endpoint que ya tienes
                        let r = await fetch(`/api/verificar_factura?idLectura=${lectura.idLectura}`);
                        if (r.ok) {
                            let jr = await r.json();
                            if (jr.existe) estadoFacturaBadge = '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Facturada</span>';
                        }
                    } catch (e) {
                        // silencioso
                    }

                    filas += `
                        <tr>
                            <td class="fw-semibold">${fecha}</td>
                            <td>${prev}</td>
                            <td>${curr}</td>
                            <td>${consumo}</td>
                            <td>${estadoFacturaBadge}</td>
                        </tr>
                    `;
                }
            }
            tblLecturas.innerHTML = filas;
        }

        // Mostrar pagos
        function mostrarPagos(pagos) {
            let filas = "";
            if (!pagos || pagos.length === 0) {
                filas = `<tr><td colspan="5" class="text-center py-4"><i class="bi bi-inbox" style="font-size:2rem;color:#ccc"></i><p class="text-muted mt-2">No hay pagos registrados</p></td></tr>`;
            } else {
                pagos.forEach(p => {
                    let fecha = new Date(p.fechaPago + 'T00:00:00').toLocaleDateString('es-SV');
                    filas += `
                        <tr>
                            <td>${fecha}</td>
                            <td>${p.idFactura || p.facturaId || '-'}</td>
                            <td>${p.tipoFactura || '-'}</td>
                            <td>$${parseFloat(p.monto || p.montoPagado || 0).toFixed(2)}</td>
                            <td>${p.metodoPago || p.method || '-'}</td>
                        </tr>
                    `;
                });
            }
            tblPagos.innerHTML = filas;
        }

        // Exportar facturas (simple CSV)
        btnExportarFacturas.addEventListener('click', () => {
            if (!detalleCache || !detalleCache.facturas || !detalleCache.facturas.detalle) {
                Swal.fire({ icon: 'info', title: 'Sin datos', text: 'No hay facturas para exportar.'});
                return;
            }
            let rows = detalleCache.facturas.detalle;
            let csv = 'idFactura,tipo,fechaEmision,fechaVencimiento,monto,estado\n';
            rows.forEach(r => {
                csv += `${r.idFactura || ''},${(r.tipoFactura||'')},${r.fechaEmision||''},${r.fechaVencimiento||''},${r.montoTotal||0},${r.estado||''}\n`;
            });
            let blob = new Blob([csv], {type: 'text/csv'});
            let url = URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url;
            a.download = `facturas_usuario_${detalleCache.usuario.idUsuario || '0'}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        });

    </script>
</body>
</html>
